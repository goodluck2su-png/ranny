name: Daily Pattern Scan

on:
  schedule:
    # ë§¤ì¼ ì˜¤í›„ 4ì‹œ 30ë¶„ (KST) = ì˜¤ì „ 7ì‹œ 30ë¶„ (UTC)
    - cron: '30 7 * * *'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pykrx pandas numpy scipy tqdm matplotlib mplfinance

      - name: Run pattern scanner
        run: |
          cd src
          python -c "
          import sys
          sys.path.insert(0, '.')
          from data_collector import filter_stocks_fast
          from pattern_detector import scan_stocks
          from chart_visualizer import generate_top_charts, ensure_dirs
          from config import OUTPUT_DIR

          print('=' * 50)
          print('ì—­í—¤ë“œì•¤ìˆ„ë” íŒ¨í„´ ìŠ¤ìºë„ˆ - GitHub Actions')
          print('=' * 50)

          # 1. ì¢…ëª© í•„í„°ë§
          print('\n[1/3] ì¢…ëª© í•„í„°ë§ ì¤‘...')
          filtered_stocks = filter_stocks_fast(verbose=True)
          print(f'í•„í„°ë§ëœ ì¢…ëª©: {len(filtered_stocks)}ê°œ')

          if len(filtered_stocks) == 0:
              print('í•„í„°ë§ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.')
              sys.exit(0)

          # 2. íŒ¨í„´ ìŠ¤ìº”
          print('\n[2/3] íŒ¨í„´ ìŠ¤ìº” ì¤‘...')
          results = scan_stocks(filtered_stocks, verbose=True)
          print(f'íŒ¨í„´ ë°œê²¬: {len(results)}ê°œ ì¢…ëª©')

          if len(results) == 0:
              print('íŒ¨í„´ì´ ë°œê²¬ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.')
              sys.exit(0)

          # 3. ê²°ê³¼ ì €ìž¥ ë° ì°¨íŠ¸ ìƒì„±
          print('\n[3/3] ê²°ê³¼ ì €ìž¥ ë° ì°¨íŠ¸ ìƒì„± ì¤‘...')
          ensure_dirs()
          result_path = OUTPUT_DIR / 'results.csv'
          results.to_csv(result_path, index=False, encoding='utf-8-sig')
          print(f'ê²°ê³¼ ì €ìž¥: {result_path}')

          # ì°¨íŠ¸ ìƒì„±
          charts = generate_top_charts(results)
          print(f'ì°¨íŠ¸ ìƒì„±: {len(charts)}ê°œ')

          print('\n' + '=' * 50)
          print('ìŠ¤ìº” ì™„ë£Œ!')
          print('=' * 50)
          "

      - name: Commit and push results
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # ê²°ê³¼ íŒŒì¼ ì¶”ê°€
          git add output/results.csv output/charts/*.png

          # ë³€ê²½ì‚¬í•­ì´ ìžˆìœ¼ë©´ ì»¤ë°‹
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ”„ Daily scan update $(date +'%Y-%m-%d %H:%M') KST"
            git push
            echo "Changes committed and pushed"
          fi

      - name: Summary
        run: |
          echo "## Daily Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f output/results.csv ]; then
            STOCK_COUNT=$(tail -n +2 output/results.csv | wc -l)
            echo "- **Detected patterns**: $STOCK_COUNT stocks" >> $GITHUB_STEP_SUMMARY
          else
            echo "- No results file found" >> $GITHUB_STEP_SUMMARY
          fi
          CHART_COUNT=$(ls -1 output/charts/*.png 2>/dev/null | wc -l)
          echo "- **Generated charts**: $CHART_COUNT files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Scan completed at $(date +'%Y-%m-%d %H:%M:%S') UTC_" >> $GITHUB_STEP_SUMMARY
